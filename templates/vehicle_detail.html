{% extends "base.html" %}{% block content %}
<h2>Vehicle: {{ vehicle.vin }}</h2>
<p>{{ vehicle.make or '-' }} {{ vehicle.model or '' }} {{ vehicle.year or '' }}</p>
<div class="row">
  <div class="card">
    <h3>New Report</h3>
    <form method="post" enctype="multipart/form-data" action="{{ url_for('ev.add_report', vehicle_id=vehicle.id) }}">
      <label>Upload log JSON file</label><input type="file" name="json_file" accept=".json"/>
      <p>— or —</p>
      <label>Paste JSON</label><textarea name="json_text" rows="8" placeholder='{"vehicle": {...}, "samples": [...]}'></textarea>
      <button type="submit">Analyze & Save</button>
    </form>
  </div>

  <div class="card">
    <h3>Reports (newest first)</h3>
    <table>
      <thead>
        <tr>
          <th>Created</th>
          <th>SoH %</th>
          <th>Cycles</th>
          <th>Anomalies (count)</th>
          <th>Download HTML</th>
        </tr>
      </thead>
      <tbody>
      {% for item in reports %}
        {% set r = item.report %}
        {% set parsed = item.parsed %}
        {% set soh = parsed.get('soh') if parsed else None %}
        {% set cdc = parsed.get('cdc_data', {}) if parsed else {} %}
        {% set an = parsed.get('anomalies', {}) if parsed else {} %}
        {% set v = an.get('voltage', {}) %}
        {% set t = an.get('temperature', {}) %}
        {% set total_anom =
              (v.get('voltage_range_anomalies', [])|length)
            + (v.get('voltage_difference_anomalies', [])|length)
            + (t.get('temperature_range_anomalies', [])|length)
            + (t.get('temperature_difference_anomalies', [])|length)
        %}
        <tr>
          <td>{{ r.created_at }}</td>
          <td>{{ '%.2f'|format(soh) if soh is not none else '-' }}</td>
          <td>{{ cdc.get('overall_cycles', '-') }}</td>
          <td>{{ total_anom }}</td>
          <td><a href="{{ url_for('ev.download_report_html', report_id=r.id) }}">HTML</a></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
